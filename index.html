<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Awtrix - Control Home Assistant</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #111; color: #eee; display:flex; justify-content:center; padding-top: 30px; margin: 0; }
        .card { background: #1c1c1e; padding: 25px; border-radius: 16px; width: 90%; max-width: 400px; border: 1px solid #333; box-shadow: 0 8px 24px rgba(0,0,0,0.5); }
        h2 { margin-top: 0; color: #03A9F4; text-align: center; }
        label { display: block; font-size: 0.8rem; color: #888; margin-top: 15px; margin-bottom: 5px; }
        input { width: 100%; padding: 12px; background: #2c2c2e; border: 1px solid #444; color: white; border-radius: 8px; box-sizing: border-box; }
        .flex-row { display: flex; gap: 10px; }
        button { width: 100%; padding: 15px; margin-top: 25px; background: #03A9F4; color: black; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; transition: 0.2s; }
        button:active { transform: scale(0.97); }
        .btn-config { background: #333; color: white; margin-top: 10px; }
        #status { text-align: center; margin-top: 15px; font-size: 0.85rem; }
        .success { color: #4CAF50; }
        .error { color: #F44336; }
        #config-panel { display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #444; }
    </style>
</head>
<body>

<div class="card">
    <h2>Control Awtrix (Local)</h2>
    
    <label>Mensaje a enviar</label>
    <input type="text" id="msg" placeholder="Ej: La cena est√° lista">
    
    <div class="flex-row">
        <div style="flex:1">
            <label>Icono (ID)</label>
            <input type="number" id="icon" placeholder="Ej: 62">
        </div>
        <div style="flex:1">
            <label>Color</label>
            <input type="color" id="color" value="#FFFFFF" style="height:43px; padding:0; cursor:pointer;">
        </div>
    </div>

    <button onclick="enviarHA()">ENVIAR AL RELOJ üöÄ</button>
    <button class="btn-config" onclick="toggleConfig()">‚öôÔ∏è Configuraci√≥n de Conexi√≥n</button>

    <div id="status">Esperando env√≠o...</div>

    <div id="config-panel">
        <label>URL de Home Assistant</label>
        <input type="text" id="ha_url" placeholder="http://192.168.1.100:8123">
        
        <label>Token de Larga Duraci√≥n</label>
        <input type="password" id="ha_token" placeholder="eyJhbGciOiJIUzI1NiIsInR5c...">
        
        <label>Topic MQTT del Reloj</label>
        <input type="text" id="ha_topic" placeholder="awtrix_XXXX/notify">
        
        <button class="btn-config" onclick="guardarConfig()">Guardar Configuraci√≥n</button>
    </div>
</div>

<script>
    // Cargar datos guardados al abrir
    window.onload = () => {
        document.getElementById('ha_url').value = localStorage.getItem('ha_url') || '';
        document.getElementById('ha_token').value = localStorage.getItem('ha_token') || '';
        document.getElementById('ha_topic').value = localStorage.getItem('ha_topic') || 'awtrix/notify';
    };

    function toggleConfig() {
        const panel = document.getElementById('config-panel');
        panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
    }

    function guardarConfig() {
        localStorage.setItem('ha_url', document.getElementById('ha_url').value.replace(/\/$/, ""));
        localStorage.setItem('ha_token', document.getElementById('ha_token').value);
        localStorage.setItem('ha_topic', document.getElementById('ha_topic').value);
        toggleConfig();
        document.getElementById('status').innerHTML = "<span class='success'>Configuraci√≥n guardada</span>";
    }

    async function enviarHA() {
        const url = localStorage.getItem('ha_url');
        const token = localStorage.getItem('ha_token');
        const topic = localStorage.getItem('ha_topic');

        if (!url || !token || !topic) {
            document.getElementById('status').innerHTML = "<span class='error'>Falta configuraci√≥n. Abre el panel ‚öôÔ∏è</span>";
            return;
        }

        const text = document.getElementById('msg').value || " ";
        const icon = document.getElementById('icon').value;
        const hex = document.getElementById('color').value;

        // Construir el JSON del mensaje para el reloj
        const awtrixPayload = {
            text: text,
            wakeup: true,
            color: [parseInt(hex.slice(1,3),16), parseInt(hex.slice(3,5),16), parseInt(hex.slice(5,7),16)]
        };
        if (icon) awtrixPayload.icon = icon;

        // Construir la petici√≥n para la API de Home Assistant
        const haBody = {
            topic: topic,
            payload: JSON.stringify(awtrixPayload)
        };

        document.getElementById('status').innerHTML = "Enviando...";

        try {
            const response = await fetch(`${url}/api/services/mqtt/publish`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(haBody)
            });

            if (response.ok) {
                document.getElementById('status').innerHTML = "<span class='success'>‚úÖ Mensaje enviado</span>";
            } else {
                document.getElementById('status').innerHTML = `<span class='error'>‚ùå Error: ${response.statusText}</span>`;
            }
        } catch (error) {
            document.getElementById('status').innerHTML = `<span class='error'>‚ùå Error de conexi√≥n. Revisa la URL.</span>`;
            console.error(error);
        }
    }
</script>
</body>
</html>
