<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Awtrix Hive Control</title>
    <link rel="icon" type="image/png" href="icon.png">
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        :root { --primary: #FFC107; --bg: #121212; --card: #1E1E1E; --text: #ffffff; --accent: #FFD54F; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 50px; }
        
        .tabs { display: flex; background: #000; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #333; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; color: #666; font-weight: bold; }
        .tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); }
        
        .content { padding: 20px; display: none; max-width: 600px; margin: 0 auto; }
        .content.active { display: block; }
        
        .card { background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid #333; margin-bottom: 15px; }
        label { display: block; font-size: 0.75rem; color: #888; margin-top: 10px; text-transform: uppercase; letter-spacing: 1px; }
        input, select, button { width: 100%; padding: 12px; margin-top: 5px; background: #2C2C2C; border: 1px solid #444; color: white; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        
        .btn-send { background: var(--primary); color: #000; font-weight: bold; border: none; margin-top: 20px; cursor: pointer; height: 50px; }
        .btn-danger { background: #CF6679; border: none; cursor: pointer; margin-top: 10px; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        #status { text-align: center; margin-top: 15px; font-size: 0.8rem; }
        .status-ok { color: #4CAF50; }
        .status-err { color: #F44336; }

        .icon-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px; }
        .icon-item { background: #333; padding: 10px; border-radius: 8px; text-align: center; cursor: pointer; }
        .icon-item img { width: 32px; height: 32px; }
    </style>
</head>
<body>

<div class="tabs">
    <div class="tab active" onclick="nav('control')">Control</div>
    <div class="tab" onclick="nav('ajustes')">Conexi贸n</div>
</div>

<div id="control" class="content active">
    <div class="card">
        <h3>Enviar Notificaci贸n</h3>
        <label>Texto</label>
        <input type="text" id="msg" placeholder="Hola Awtrix">
        
        <div class="grid">
            <div><label>Icono ID</label><input type="text" id="icon" placeholder="Ej: 6"></div>
            <div><label>Color</label><input type="color" id="color" value="#ffffff" style="height: 45px; padding: 0;"></div>
        </div>
        
        <div class="grid">
            <div><label>Modo</label><select id="rainbow"><option value="false">S贸lido</option><option value="true">Arco铆ris</option></select></div>
            <div><label>Repetir</label><input type="number" id="repeat" value="1"></div>
        </div>

        <button class="btn-send" onclick="send()">ENVIAR AHORA</button>
        <button class="btn-danger" onclick="clean()">Ч LIMPIAR PANTALLA</button>
        
        <div id="status">Esperando conexi贸n...</div>
    </div>
    
    <div class="card">
        <h3>Iconos Comunes</h3>
        <div class="icon-grid" id="icons"></div>
    </div>
</div>

<div id="ajustes" class="content">
    <div class="card">
        <h3>Configuraci贸n HiveMQ Cloud</h3>
        <p style="font-size:0.8rem; color:#aaa;">Crea tu cluster gratuito en hivemq.com y pega los datos.</p>
        
        <label>Cluster URL (Host)</label>
        <input type="text" id="host" placeholder="xxxxxxxx.s1.eu.hivemq.cloud">
        
        <label>Usuario</label>
        <input type="text" id="user">
        
        <label>Contrase帽a</label>
        <input type="password" id="pass">
        
        <button class="btn-send" onclick="save()">GUARDAR Y CONECTAR</button>
    </div>
</div>

<script>
    let client;
    const commonIcons = [6, 1338, 259, 1105, 412, 342, 555, 1];

    window.onload = () => {
        // Cargar datos guardados
        document.getElementById('host').value = localStorage.getItem('hv_host') || '';
        document.getElementById('user').value = localStorage.getItem('hv_user') || '';
        document.getElementById('pass').value = localStorage.getItem('hv_pass') || '';
        
        renderIcons();
        if(localStorage.getItem('hv_host')) connect();
    };

    function connect() {
        const host = localStorage.getItem('hv_host');
        const user = localStorage.getItem('hv_user');
        const pass = localStorage.getItem('hv_pass');
        
        document.getElementById('status').innerText = 'Conectando a HiveMQ...';
        
        // HiveMQ Cloud usa WSS en puerto 8884 para navegadores
        const url = `wss://${host}:8884/mqtt`;

        client = mqtt.connect(url, {
            username: user,
            password: pass,
            clientId: 'web_' + Math.random().toString(16).substr(2, 5),
            keepalive: 60
        });

        client.on('connect', () => {
            document.getElementById('status').className = 'status-ok';
            document.getElementById('status').innerText = ' CONECTADO (WSS)';
        });

        client.on('error', (err) => {
            console.error(err);
            document.getElementById('status').className = 'status-err';
            document.getElementById('status').innerText = ' Error: ' + err.message;
        });
        
        client.on('close', () => {
             // Reintentar silenciosamente
        });
    }

    function send() {
        if(!client || !client.connected) return alert("No conectado. Revisa la pesta帽a Conexi贸n.");
        
        const payload = {
            text: document.getElementById('msg').value || " ",
            rainbow: document.getElementById('rainbow').value === "true",
            duration: 5,
            wakeup: true
        };

        if(!payload.rainbow) {
            const hex = document.getElementById('color').value;
            payload.color = [parseInt(hex.slice(1,3),16), parseInt(hex.slice(3,5),16), parseInt(hex.slice(5,7),16)];
        }

        const icon = document.getElementById('icon').value;
        if(icon) payload.icon = icon;

        // TOPIC SIMPLE Y DIRECTO
        // Si en el reloj el prefix es "awtrix/", el topic de notificaci贸n es "awtrix/notify"
        client.publish('awtrix/notify', JSON.stringify(payload));
        
        const btn = document.querySelector('.btn-send');
        btn.innerText = "隆ENVIADO!";
        setTimeout(() => btn.innerText = "ENVIAR AHORA", 1000);
    }
    
    function clean() {
        if(client) client.publish('awtrix/notify', JSON.stringify({text: "", wakeup: true}));
    }

    function save() {
        localStorage.setItem('hv_host', document.getElementById('host').value.trim());
        localStorage.setItem('hv_user', document.getElementById('user').value.trim());
        localStorage.setItem('hv_pass', document.getElementById('pass').value.trim());
        location.reload();
    }

    function nav(id) {
        document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active');
    }

    function renderIcons() {
        const c = document.getElementById('icons');
        commonIcons.forEach(i => {
            c.innerHTML += `<div class="icon-item" onclick="setIcon(${i})">
                <img src="https://developer.lametric.com/content/apps/icon_thumbs/${i}.png"><br><small>#${i}</small>
            </div>`;
        });
    }
    
    window.setIcon = (id) => document.getElementById('icon').value = id;
</script>
</body>
</html>
