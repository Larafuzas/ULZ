<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Awtrix Master Control</title>
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        :root { --primary: #007AFF; --bg: #000000; --card: #1c1c1e; --text: #ffffff; --pastel: #ADE1F5; --danger: #FF3B30; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; color: var(--text); padding-bottom: 50px; }
        
        .tabs { display: flex; background: #111; border-bottom: 1px solid #333; position: sticky; top: 0; z-index: 100; overflow-x: auto; }
        .tab { flex: 1; padding: 18px; text-align: center; cursor: pointer; color: #888; font-weight: 600; min-width: 90px; transition: 0.3s; }
        .tab.active { color: var(--pastel); border-bottom: 3px solid var(--pastel); background: rgba(173, 225, 245, 0.05); }

        .content { padding: 20px; display: none; max-width: 800px; margin: 0 auto; animation: fadeIn 0.3s; }
        .content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: var(--card); padding: 20px; border-radius: 20px; border: 1px solid #2c2c2e; margin-bottom: 20px; }
        h3 { margin-top: 0; color: var(--pastel); font-size: 1.1rem; }
        
        label { display: block; font-size: 0.7rem; color: #aaa; margin-top: 15px; font-weight: bold; text-transform: uppercase; }
        input, select, button { width: 100%; padding: 12px; margin-top: 8px; border: 1px solid #333; border-radius: 12px; font-size: 1rem; box-sizing: border-box; background: #2c2c2e; color: white; outline: none; }
        
        .grid-params { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .send-btn { background: var(--primary); border: none; font-weight: bold; margin-top: 25px; height: 60px; font-size: 1.1rem; cursor: pointer; }
        
        /* Gesti√≥n de Mensajes */
        .msg-item { display: flex; justify-content: space-between; align-items: center; background: #2c2c2e; padding: 12px; border-radius: 12px; margin-bottom: 8px; border: 1px solid #444; }
        .msg-name { font-weight: bold; flex-grow: 1; cursor: pointer; color: var(--pastel); }
        .delete-btn { background: var(--danger); border: none; padding: 6px 12px; border-radius: 8px; width: auto; font-size: 0.75rem; cursor: pointer; }

        /* Iconos */
        .icon-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px; }
        .icon-item { background: #2c2c2e; padding: 10px; border-radius: 12px; text-align: center; cursor: pointer; border: 1px solid #444; transition: 0.2s; }
        .icon-item:hover { border-color: var(--pastel); transform: scale(1.05); }
        .icon-item img { width: 40px; height: 40px; image-rendering: pixelated; background: #000; border-radius: 4px; }
        .icon-item span { display: block; font-size: 0.6rem; margin-top: 5px; color: #888; }

        #status { text-align: center; font-size: 0.75rem; color: #666; margin-top: 15px; cursor: pointer; text-decoration: underline; }
    </style>
</head>
<body>

<div class="tabs">
    <div class="tab active" onclick="showTab('messenger')">Control</div>
    <div class="tab" onclick="showTab('saved-msgs')">Mensajes</div>
    <div class="tab" onclick="showTab('library')">Iconos</div>
    <div class="tab" onclick="showTab('settings')">Ajustes</div>
</div>

<div id="messenger" class="content active">
    <div class="card">
        <h3>Nueva Notificaci√≥n</h3>
        <label>Mensaje</label>
        <input type="text" id="mensaje" placeholder="¬°Escribe aqu√≠!">
        
        <div class="grid-params">
            <div>
                <label>Color Texto</label>
                <select id="colorMode" onchange="toggleColor()">
                    <option value="solid">S√≥lido</option>
                    <option value="rainbow">Arco√≠ris</option>
                </select>
            </div>
            <div id="pickerBox"><label>&nbsp;</label><input type="color" id="color" value="#ffffff" style="height: 48px; padding: 2px;"></div>
        </div>

        <div class="grid-params">
            <div><label>Icono (ID o Local)</label><input type="text" id="iconInput" placeholder="Ej: 1338"></div>
            <div><label>Posici√≥n</label><select id="pushIcon"><option value="0">Izquierda</option><option value="1">Derecha</option></select></div>
        </div>

        <div class="grid-params">
            <div><label>Duraci√≥n (s)</label><input type="number" id="duration" value="5"></div>
            <div><label>Repetir</label><input type="number" id="repeat" value="1"></div>
        </div>

        <button class="send-btn" onclick="enviarMQTT()">ENVIAR AL RELOJ</button>
        <button onclick="guardarFavorito()" style="background: #34C759; border:none; margin-top: 10px; cursor:pointer; font-weight: bold;">üíæ GUARDAR EN MIS MENSAJES</button>
        <div id="status" onclick="showTab('settings')">Configuraci√≥n requerida</div>
    </div>
</div>

<div id="saved-msgs" class="content">
    <div class="card">
        <h3>Mensajes Guardados</h3>
        <div id="listadoMensajes"></div>
    </div>
    <div class="card">
        <h3>Copia de Seguridad</h3>
        <button onclick="exportarJSON()" style="background: #5856D6; border:none; margin-bottom: 10px; cursor:pointer;">üì§ EXPORTAR ARCHIVO .JSON</button>
        <input type="file" id="importFile" onchange="importarJSON(this)" style="display:none">
        <button onclick="document.getElementById('importFile').click()" style="background: #8e8e93; border:none; cursor:pointer;">üì• IMPORTAR ARCHIVO .JSON</button>
    </div>
</div>

<div id="library" class="content">
    <div class="card" style="border-color: var(--primary); background: rgba(0, 122, 255, 0.1);">
        <h3>Galer√≠a Completa</h3>
        <p style="font-size: 0.85rem; color: #ccc;">Busca entre miles de iconos oficiales, copia el ID num√©rico y p√©galo en Control.</p>
        <a href="https://developer.lametric.com/icons" target="_blank">
            <button style="background: var(--primary); border:none; font-weight: bold; cursor:pointer;">ABRIR LAMETRIC GALLERY ‚Üó</button>
        </a>
    </div>

    <div class="card">
        <h3>Favoritos R√°pidos</h3>
        <div id="iconGrid" class="icon-grid"></div>
    </div>
</div>

<div id="settings" class="content">
    <div class="card">
        <h3>Adafruit IO</h3>
        <label>Usuario</label><input type="text" id="ad_user" placeholder="Tu usuario">
        <label>AIO Key</label><input type="password" id="ad_key" placeholder="Tu clave aio_...">
        <label>Feed</label><input type="text" id="ad_feed" value="notify">
        <button class="send-btn" style="background: #34C759;" onclick="guardarConfig()">GUARDAR Y CONECTAR</button>
        <button onclick="borrarTodo()" style="background: var(--danger); border:none; margin-top: 20px; font-size: 0.7rem; cursor:pointer;">üóëÔ∏è BORRAR TODOS LOS DATOS LOCALES</button>
    </div>
</div>

<script>
    let client = null;
    const popularIcons = [1241, 1338, 2125, 6, 259, 1105, 412, 342, 488, 2238, 555, 1, 141, 201, 301, 401];

    window.onload = () => {
        document.getElementById('ad_user').value = localStorage.getItem('ad_user') || '';
        document.getElementById('ad_key').value = localStorage.getItem('ad_key') || '';
        document.getElementById('ad_feed').value = localStorage.getItem('ad_feed') || 'notify';
        
        cargarIconosFavoritos();
        actualizarListaMensajes();
        if(localStorage.getItem('ad_key')) conectarAdafruit();
    };

    function conectarAdafruit() {
        const user = localStorage.getItem('ad_user');
        const key = localStorage.getItem('ad_key');
        if(!user || !key) return;

        client = mqtt.connect(`wss://io.adafruit.com:443`, {
            username: user, password: key,
            clientId: 'web_' + Math.random().toString(16).substr(2, 6)
        });

        client.on('connect', () => document.getElementById('status').innerText = 'üü¢ CONECTADO');
        client.on('error', () => document.getElementById('status').innerText = 'üî¥ ERROR DE CONEXI√ìN');
    }

    function enviarMQTT() {
        if(!client?.connected) return alert("Primero configura tus datos en Ajustes.");
        
        const isRainbow = document.getElementById('colorMode').value === 'rainbow';
        const hex = document.getElementById('color').value;
        const payload = {
            text: document.getElementById('mensaje').value || " ",
            rainbow: isRainbow,
            duration: parseInt(document.getElementById('duration').value) || 5,
            repeat: parseInt(document.getElementById('repeat').value) || 1,
            wakeup: true
        };

        if(!isRainbow) {
            payload.color = [parseInt(hex.slice(1,3),16), parseInt(hex.slice(3,5),16), parseInt(hex.slice(5,7),16)];
        }
        
        const icon = document.getElementById('iconInput').value.trim();
        if(icon) {
            payload.icon = icon;
            payload.pushIcon = parseInt(document.getElementById('pushIcon').value);
        }

        const user = localStorage.getItem('ad_user');
        const feed = localStorage.getItem('ad_feed');
        client.publish(`${user}/feeds/${feed}`, JSON.stringify(payload));
        
        const btn = document.querySelector('.send-btn');
        btn.innerText = "¬°ENVIADO!";
        setTimeout(() => btn.innerText = "ENVIAR AL RELOJ", 1500);
    }

    // --- LOGICA DE MENSAJES ---
    function guardarFavorito() {
        const nombre = prompt("Nombre para guardar este mensaje:");
        if (!nombre) return;
        let r = JSON.parse(localStorage.getItem('rapidos') || '{}');
        r[nombre] = {
            text: document.getElementById('mensaje').value,
            colorMode: document.getElementById('colorMode').value,
            color: document.getElementById('color').value,
            icon: document.getElementById('iconInput').value,
            pushIcon: document.getElementById('pushIcon').value,
            duration: document.getElementById('duration').value,
            repeat: document.getElementById('repeat').value
        };
        localStorage.setItem('rapidos', JSON.stringify(r));
        actualizarListaMensajes();
    }

    function actualizarListaMensajes() {
        const container = document.getElementById('listadoMensajes');
        const r = JSON.parse(localStorage.getItem('rapidos') || '{}');
        container.innerHTML = '';
        for (let n in r) {
            const div = document.createElement('div');
            div.className = 'msg-item';
            div.innerHTML = `<span class="msg-name" onclick="aplicarMensaje('${n}')">${n}</span>
                             <button class="delete-btn" onclick="borrarMensaje('${n}')">Borrar</button>`;
            container.appendChild(div);
        }
    }

    function aplicarMensaje(n) {
        const c = JSON.parse(localStorage.getItem('rapidos'))[n];
        document.getElementById('mensaje').value = c.text;
        document.getElementById('colorMode').value = c.colorMode;
        document.getElementById('color').value = c.color;
        document.getElementById('iconInput').value = c.icon;
        document.getElementById('pushIcon').value = c.pushIcon;
        document.getElementById('duration').value = c.duration;
        document.getElementById('repeat').value = c.repeat;
        toggleColor();
        showTab('messenger');
    }

    function borrarMensaje(n) {
        if(confirm(`¬øEliminar "${n}"?`)) {
            let r = JSON.parse(localStorage.getItem('rapidos'));
            delete r[n];
            localStorage.setItem('rapidos', JSON.stringify(r));
            actualizarListaMensajes();
        }
    }

    // --- ICONOS ---
    function cargarIconosFavoritos() {
        const grid = document.getElementById('iconGrid');
        grid.innerHTML = '';
        popularIcons.forEach(id => {
            const div = document.createElement('div');
            div.className = 'icon-item';
            div.innerHTML = `<img src="https://developer.lametric.com/content/apps/icon_thumbs/${id}.png"><span>#${id}</span>`;
            div.onclick = () => { document.getElementById('iconInput').value = id; showTab('messenger'); };
            grid.appendChild(div);
        });
    }

    // --- AUXILIARES ---
    function exportarJSON() {
        const blob = new Blob([localStorage.getItem('rapidos') || '{}'], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'respaldo_awtrix.json';
        a.click();
    }

    function importarJSON(i) {
        const fr = new FileReader();
        fr.onload = (e) => {
            localStorage.setItem('rapidos', e.target.result);
            actualizarListaMensajes();
            alert("Mensajes importados correctamente.");
        };
        fr.readAsText(i.files[0]);
    }

    function showTab(t) {
        document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
        document.getElementById(t).classList.add('active');
        event.currentTarget.classList.add('active');
    }

    function toggleColor() { document.getElementById('pickerBox').style.opacity = document.getElementById('colorMode').value === 'rainbow' ? '0.3' : '1'; }

    function guardarConfig() {
        localStorage.setItem('ad_user', document.getElementById('ad_user').value.trim());
        localStorage.setItem('ad_key', document.getElementById('ad_key').value.trim());
        localStorage.setItem('ad_feed', document.getElementById('ad_feed').value.trim());
        location.reload();
    }

    function borrarTodo() {
        if(confirm("¬øBorrar permanentemente todos los ajustes y mensajes favoritos?")) {
            localStorage.clear();
            location.reload();
        }
    }
</script>
</body>
</html>
