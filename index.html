<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Awtrix Master Control</title>
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        :root { --primary: #007AFF; --bg: #000000; --card: #1c1c1e; --text: #ffffff; --pastel: #ADE1F5; --danger: #FF3B30; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; color: var(--text); padding-bottom: 50px; }
        .tabs { display: flex; background: #111; border-bottom: 1px solid #333; position: sticky; top: 0; z-index: 100; overflow-x: auto; }
        .tab { flex: 1; padding: 18px; text-align: center; cursor: pointer; color: #888; font-weight: 600; min-width: 90px; }
        .tab.active { color: var(--pastel); border-bottom: 3px solid var(--pastel); background: rgba(173, 225, 245, 0.05); }
        .content { padding: 20px; display: none; max-width: 800px; margin: 0 auto; }
        .content.active { display: block; }
        .card { background: var(--card); padding: 20px; border-radius: 20px; border: 1px solid #2c2c2e; margin-bottom: 20px; }
        h3 { margin-top: 0; color: var(--pastel); }
        label { display: block; font-size: 0.7rem; color: #aaa; margin-top: 15px; font-weight: bold; text-transform: uppercase; }
        input, select, button { width: 100%; padding: 12px; margin-top: 8px; border: 1px solid #333; border-radius: 12px; font-size: 1rem; box-sizing: border-box; background: #2c2c2e; color: white; outline: none; }
        .grid-params { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .send-btn { background: var(--primary); border: none; font-weight: bold; margin-top: 25px; height: 60px; font-size: 1.1rem; cursor: pointer; }
        .icon-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px; }
        .icon-item { background: #2c2c2e; padding: 10px; border-radius: 12px; text-align: center; cursor: pointer; border: 1px solid #444; }
        .icon-item img { width: 40px; height: 40px; image-rendering: pixelated; background: #000; border-radius: 4px; }
        #status { text-align: center; font-size: 0.75rem; color: #666; margin-top: 15px; }
        .msg-item { display: flex; justify-content: space-between; align-items: center; background: #2c2c2e; padding: 12px; border-radius: 12px; margin-bottom: 8px; border: 1px solid #444; }
        .delete-btn { background: var(--danger); border: none; padding: 6px 12px; border-radius: 8px; width: auto; cursor: pointer; }
    </style>
</head>
<body>

<div class="tabs">
    <div class="tab active" onclick="showTab('messenger')">Control</div>
    <div class="tab" onclick="showTab('saved-msgs')">Mensajes</div>
    <div class="tab" onclick="showTab('library')">Iconos</div>
    <div class="tab" onclick="showTab('settings')">Ajustes</div>
</div>

<div id="messenger" class="content active">
    <div class="card">
        <h3>Enviar NotificaciÃ³n</h3>
        <label>Mensaje</label>
        <input type="text" id="mensaje" placeholder="Escribe un mensaje...">
        <div class="grid-params">
            <div><label>Color</label><select id="colorMode" onchange="toggleColor()"><option value="solid">SÃ³lido</option><option value="rainbow">ArcoÃ­ris</option></select></div>
            <div id="pickerBox"><label>&nbsp;</label><input type="color" id="color" value="#ffffff" style="height: 48px;"></div>
        </div>
        <div class="grid-params">
            <div><label>Icono</label><input type="text" id="iconInput" placeholder="ID (ej: 1338)"></div>
            <div><label>PosiciÃ³n</label><select id="pushIcon"><option value="0">Izq</option><option value="1">Der</option></select></div>
        </div>
        <button class="send-btn" onclick="enviarMQTT()">ENVIAR AL RELOJ</button>
        <button onclick="guardarFav()" style="background: #34C759; margin-top: 10px; border:none; cursor:pointer; font-weight:bold;">ðŸ’¾ GUARDAR FAVORITO</button>
        <div id="status">Desconectado</div>
    </div>
</div>

<div id="saved-msgs" class="content">
    <div class="card"><h3>Favoritos</h3><div id="listado"></div></div>
</div>

<div id="library" class="content">
    <div class="card" style="background: rgba(0,122,255,0.1); border-color: var(--primary);">
        <h3>GalerÃ­a LaMetric</h3>
        <a href="https://developer.lametric.com/icons" target="_blank"><button style="background:var(--primary); border:none; cursor:pointer;">BUSCAR ICONOS â†—</button></a>
    </div>
    <div class="card"><div id="iconGrid" class="icon-grid"></div></div>
</div>

<div id="settings" class="content">
    <div class="card">
        <h3>Adafruit Config</h3>
        <label>Usuario</label><input type="text" id="ad_user" placeholder="Larafuzas">
        <label>AIO Key</label><input type="password" id="ad_key" placeholder="aio_...">
        <label>Feed</label><input type="text" id="ad_feed" value="notify">
        <button class="send-btn" style="background:#34C759;" onclick="guardarSet()">GUARDAR Y RECONECTAR</button>
    </div>
</div>

<script>
    let client = null;
    const icons = [1241, 1338, 2125, 6, 259, 1105, 412, 342, 488, 2238, 555, 1, 141, 201, 301, 401];

    window.onload = () => {
        document.getElementById('ad_user').value = localStorage.getItem('ad_user') || '';
        document.getElementById('ad_key').value = localStorage.getItem('ad_key') || '';
        document.getElementById('ad_feed').value = localStorage.getItem('ad_feed') || 'notify';
        renderIconos();
        renderFavs();
        if(localStorage.getItem('ad_key')) conectar();
    };

    function conectar() {
        const u = localStorage.getItem('ad_user');
        const k = localStorage.getItem('ad_key');
        if(!u || !k) return;

        client = mqtt.connect(`wss://io.adafruit.com:443`, { 
            username: u, 
            password: k, 
            clientId: 'web_' + Math.random().toString(16).substr(2,6) 
        });

        client.on('connect', () => {
            document.getElementById('status').innerText = 'ðŸŸ¢ CONECTADO A ADAFRUIT';
            document.getElementById('status').style.color = '#34C759';
        });

        client.on('error', () => {
            document.getElementById('status').innerText = 'ðŸ”´ ERROR DE CONEXIÃ“N';
            document.getElementById('status').style.color = '#FF3B30';
        });
    }

    function enviarMQTT() {
        if(!client?.connected) return alert("Revisa la conexiÃ³n en la pestaÃ±a Ajustes.");
        
        const isR = document.getElementById('colorMode').value === 'rainbow';
        const hex = document.getElementById('color').value;
        
        const payload = {
            text: document.getElementById('mensaje').value || " ",
            rainbow: isR,
            wakeup: true,
            duration: 5
        };

        if(!isR) {
            payload.color = [parseInt(hex.slice(1,3),16), parseInt(hex.slice(3,5),16), parseInt(hex.slice(5,7),16)];
        }

        const ic = document.getElementById('iconInput').value.trim();
        if(ic) { 
            payload.icon = ic; 
            payload.pushIcon = parseInt(document.getElementById('pushIcon').value); 
        }

        const u = localStorage.getItem('ad_user');
        const f = localStorage.getItem('ad_feed') || 'notify';
        const topic = `${u}/feeds/${f.toLowerCase()}`;

        client.publish(topic, JSON.stringify(payload));
        
        const b = document.querySelector('.send-btn');
        b.innerText = "Â¡ENVIADO!";
        setTimeout(() => b.innerText = "ENVIAR AL RELOJ", 1500);
    }

    // --- FAVORITOS ---
    function guardarFav() {
        const n = prompt("Nombre para este favorito:");
        if(!n) return;
        let r = JSON.parse(localStorage.getItem('rapidos') || '{}');
        r[n] = { 
            text: document.getElementById('mensaje').value, 
            icon: document.getElementById('iconInput').value,
            color: document.getElementById('color').value,
            colorMode: document.getElementById('colorMode').value
        };
        localStorage.setItem('rapidos', JSON.stringify(r));
        renderFavs();
    }

    function renderFavs() {
        const c = document.getElementById('listado');
        const r = JSON.parse(localStorage.getItem('rapidos') || '{}');
        c.innerHTML = '';
        for(let n in r) {
            const d = document.createElement('div');
            d.className = 'msg-item';
            d.innerHTML = `<span style="cursor:pointer; font-weight:bold; color:var(--pastel);" onclick="cargar('${n}')">${n}</span>
                           <button class="delete-btn" onclick="borrar('${n}')">Borrar</button>`;
            c.appendChild(d);
        }
    }

    function cargar(n) {
        const d = JSON.parse(localStorage.getItem('rapidos'))[n];
        document.getElementById('mensaje').value = d.text;
        document.getElementById('iconInput').value = d.icon || '';
        document.getElementById('color').value = d.color || '#ffffff';
        document.getElementById('colorMode').value = d.colorMode || 'solid';
        toggleColor();
        showTab('messenger');
    }

    function borrar(n) {
        if(!confirm(`Â¿Borrar "${n}"?`)) return;
        let r = JSON.parse(localStorage.getItem('rapidos'));
        delete r[n];
        localStorage.setItem('rapidos', JSON.stringify(r));
        renderFavs();
    }

    // --- UI ---
    function renderIconos() {
        const g = document.getElementById('iconGrid');
        icons.forEach(id => {
            const d = document.createElement('div');
            d.className = 'icon-item';
            d.innerHTML = `<img src="https://developer.lametric.com/content/apps/icon_thumbs/${id}.png"><span>#${id}</span>`;
            d.onclick = () => { 
                document.getElementById('iconInput').value = id; 
                showTab('messenger'); 
            };
            g.appendChild(d);
        });
    }

    function showTab(t) {
        document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
        document.getElementById(t).classList.add('active');
        event.currentTarget.classList.add('active');
    }

    function toggleColor() { 
        document.getElementById('pickerBox').style.opacity = document.getElementById('colorMode').value === 'rainbow' ? '0.3' : '1'; 
    }

    function guardarSet() {
        localStorage.setItem('ad_user', document.getElementById('ad_user').value.trim());
        localStorage.setItem('ad_key', document.getElementById('ad_key').value.trim());
        localStorage.setItem('ad_feed', document.getElementById('ad_feed').value.trim());
        location.reload();
    }
</script>
</body>
</html>
